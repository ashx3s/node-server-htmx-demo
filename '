"use strict";

const http = require("node:http");
const fs = require("node:fs");
const fsPromise = require("node:fs/promises");
const path = require("node:path");

const checkFileAndHandleErrors = require("./utils/checkFileAndHandleErrors");
const { sendText, sendHtml, sendHtmlFile, sendJson, handleNotFound, handleServerError } = require("./utils/responseHandlers");
const { requestHandler } = require("./utils/requestHandlers");
const pageData = require("./utils/pageDataDemo");

function logUrlEncodedRequestData(req, res) {
	if (!req) {
		console.error("[Error]: No request was passed");
	}
		let body = ""
		req.on("data", (chunk) => {
			body += chunk.toString()
		})
		req.on("end", () => {
			console.log(req.headers['content-type'])
			console.log(body)
		})
	res.writeHead(200, {"Content-Type": "text/plain"})
	res.end("Contact form data received and logged in raw form.")
	req.on("error", (err) => {
			console.error("Request Error: ", err)
			res.writeHead(500, {"Content-Type": "text/plain"})
			res.end("Server error processing request");
		})
}

// TODO: use ...params to dynamically log whatever parameters are passed
function logDataParsedWithSearchParams(req, res, ...inputParams) {
	let body = ''
	req.on("data", (chunk) => {
		body += chunk.toString()
	})

	req.on("end", () => {
		console.log("Content-Type Header: ", req.headers["content-type"]);
		console.log("Raw body: ", body);
		if (req.headers['content-type'] === 'application/x-www-form-urlencoded') {
			const params = new URLSearchParams(body);
			for (param of inputParams) {
				console.log(param)
			}
		
			res.writeHead(200, {"Content-Type": "text/plain"})
			res.end("Contact form data received and parsed using URLSearchParams");
		} else {
			res.writeHead(400, { "Content-Type": "text/plain" });
			res.end("Unsupported content type for parsing with URLSearchParams");
		}
	})
}
const server = http.createServer(async (req, res) => {
	const url = req.url;
	const method = req.method;

	console.log(`Request: ${method} ${url}`);

	if (url === "/" && method === "GET") {
		sendHtmlFile(res, "index.html")
	} else if (url === "/request" && (method === "POST" || method === "PUT")) {
		requestHandler(req, res, url, 200, "text/plain")
	} else if (url === "/about" && method === "GET") {
		sendHtml(res, pageData(url), 200)
	} else if (url === "/contact" && method === "GET") {
		sendHtmlFile(res, "contact.html");
	} else if (url === "/contact" && method === "POST") { 
		//original approach -- logUrlEncodedRequestData(req, res);	
		logDataParsedWithSearchParams(req, res);
		} else {
		handleNotFound(res, "Requested Page")
	}
})
server.listen(8000, () => {
	console.log(`Listening on http://localhost:8000`);
})
